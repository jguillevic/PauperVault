@page
@using Microsoft.Extensions.Options
@using PauperVault.Web.Options
@inject IOptions<FirebaseWebOptions> FirebaseWeb
@model PauperVault.Web.Pages.Auth.LoginModel
@{
    ViewData["Title"] = "Connexion";

    var jsonOptions = new System.Text.Json.JsonSerializerOptions
    {
        PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
    };
}

<h1>Connexion</h1>

<button class="btn btn-primary" id="googleBtn">
    Se connecter avec Google
</button>

<div class="text-danger mt-2" id="err"></div>

@section Scripts {
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithRedirect,
            getRedirectResult,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        // 🔑 Firebase Web config (non secret, camelCase)
        const firebaseConfig = @Html.Raw(
                    System.Text.Json.JsonSerializer.Serialize(FirebaseWeb.Value, jsonOptions)
            );

    console.log("Firebase config:", firebaseConfig);

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        async function getCsrf() {
            const r = await fetch("/api/auth/csrf", { credentials: "same-origin" });
            const j = await r.json();
            return j.csrfToken;
        }

        // 🔁 1) Gestion du retour APRÈS redirect Google
        (async () => {
            try {
                const result = await getRedirectResult(auth);

                console.log("Redirect result:", result);

                if (!result || !result.user) return;

                const idToken = await result.user.getIdToken();
                const csrfToken = await getCsrf();

                const res = await fetch("/api/auth/sessionLogin", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({ idToken, csrfToken })
                });

                if (!res.ok) {
                    const payload = await res.json().catch(async () => ({ error: await res.text() }));
                    throw new Error(payload.error ?? "Connexion refusée");
                }

                window.location.href = "/Me";
            } catch (e) {
                console.error(e);
                document.getElementById("err").textContent =
                    e?.message ?? "Erreur lors de la connexion";
            }
        })();

        // 🚀 2) Lancer le redirect Google
        document.getElementById("googleBtn").addEventListener("click", async () => {
            document.getElementById("err").textContent = "";

            // ✅ IMPORTANT : persistance AVANT redirect
            await setPersistence(auth, browserLocalPersistence);

            await signInWithRedirect(auth, provider);
        });
    </script>
}
