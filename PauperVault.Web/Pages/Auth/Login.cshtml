@page
@using Microsoft.Extensions.Options
@using PauperVault.Web.Options
@inject IOptions<FirebaseWebOptions> FirebaseWeb
@model PauperVault.Web.Pages.Auth.LoginModel
@{
    ViewData["Title"] = "Connexion";

    var jsonOptions = new System.Text.Json.JsonSerializerOptions
    {
        PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
    };
}

<h1>Connexion</h1>

<button class="btn btn-primary" id="googleBtn">
    Se connecter avec Google
</button>

<div class="text-danger mt-2" id="err"></div>

@section Scripts {
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithRedirect,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        const firebaseConfig = @Html.Raw(
                    System.Text.Json.JsonSerializer.Serialize(FirebaseWeb.Value, jsonOptions)
            );

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

        async function getCsrf() {
            const r = await fetch("/api/auth/csrf", { credentials: "same-origin" });
            const j = await r.json();
            return j.csrfToken;
        }

        // ✅ SOLUTION ROBUSTE : écouter l’état Firebase
        onAuthStateChanged(auth, async (user) => {
            if (!user) return;

            try {
                const idToken = await user.getIdToken();
                const csrfToken = await getCsrf();

                const res = await fetch("/api/auth/sessionLogin", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({ idToken, csrfToken })
                });

                if (!res.ok) throw new Error("Session login failed");

                window.location.href = "/Me";
            } catch (e) {
                console.error(e);
                document.getElementById("err").textContent =
                    e?.message ?? "Erreur lors de la connexion";
            }
        });

        // 🚀 Lancer le redirect Google
        document.getElementById("googleBtn").addEventListener("click", async () => {
            document.getElementById("err").textContent = "";
            await setPersistence(auth, browserLocalPersistence);
            await signInWithRedirect(auth, provider);
        });
    </script>
}
